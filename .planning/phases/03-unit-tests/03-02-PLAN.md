---
phase: 03-unit-tests
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [tests/client/N8nApiClient.test.ts]
---

<objective>
Add comprehensive unit tests for N8nApiClient HTTP client.

Purpose: Ensure API client handles success paths, error conditions, and edge cases correctly. Mock fetch to test without real n8n instance.
Output: Full test coverage for N8nApiClient methods.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md
@.planning/phases/03-unit-tests/03-01-SUMMARY.md
@src/client/index.ts
@src/client/types.ts
@src/errors/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for successful API operations</name>
  <files>tests/client/N8nApiClient.test.ts</files>
  <action>
Create tests/client/N8nApiClient.test.ts with test suites for:

1. Mock setup:
   - Use vi.stubGlobal('fetch', ...) to mock global fetch
   - Create helper to mock successful responses with JSON data
   - beforeEach: reset mocks, create fresh client instance

2. Test suites for each method (success paths):
   - listWorkflows(): returns array from response.data, handles query params (cursor, limit, active, tags)
   - getWorkflow(id): returns workflow object
   - createWorkflow(data): sends POST with body, returns created workflow
   - updateWorkflow(id, data): sends PUT with body, returns updated workflow
   - deleteWorkflow(id): sends DELETE, returns void (204 response)
   - activateWorkflow(id): sends POST to /activate, returns workflow
   - deactivateWorkflow(id): sends POST to /deactivate, returns workflow
   - testConnection(): returns success result with workflowCount

3. Verify each method:
   - Calls fetch with correct URL (baseUrl + endpoint)
   - Includes X-N8N-API-KEY header
   - Uses correct HTTP method
   - Includes body for POST/PUT methods

Follow existing test patterns:
- describe/it blocks with clear names
- beforeEach for setup, afterEach for cleanup
- Arrange/Act/Assert structure
  </action>
  <verify>npm run test -- tests/client/N8nApiClient.test.ts passes all success path tests</verify>
  <done>Success path tests cover all 8 public methods of N8nApiClient</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for error handling</name>
  <files>tests/client/N8nApiClient.test.ts</files>
  <action>
Add error handling test suites to tests/client/N8nApiClient.test.ts:

1. N8nConnectionError tests:
   - fetch throws TypeError (network error) → throws N8nConnectionError with message
   - fetch rejects with error → wraps in N8nConnectionError

2. N8nAuthenticationError tests:
   - 401 response → throws N8nAuthenticationError

3. N8nApiError tests:
   - 400/404/500 responses → throws N8nApiError with status code
   - Response with message field → includes message in error
   - Response without message field → uses generic "Request failed" message
   - Non-JSON error response → handles gracefully

4. testConnection() error handling:
   - N8nAuthenticationError → returns { success: false, message: 'Authentication failed...' }
   - N8nConnectionError → returns { success: false, message: 'Connection failed: ...' }
   - Other errors → returns { success: false, message: error.message }

Use rejects.toThrow() for async error testing.
  </action>
  <verify>npm run test -- tests/client/N8nApiClient.test.ts passes all error handling tests</verify>
  <done>Error handling tests cover connection errors, auth errors, and API errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] tests/client/N8nApiClient.test.ts exists
- [ ] All N8nApiClient public methods have success tests
- [ ] Error handling covers N8nConnectionError, N8nAuthenticationError, N8nApiError
- [ ] testConnection() error paths tested
- [ ] npm run test passes all tests
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- N8nApiClient fully tested
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-unit-tests/03-02-SUMMARY.md`
</output>
